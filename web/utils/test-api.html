<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradio API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #005fa3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .file-input {
            margin: 10px 0;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ§ª Gradio API Connection Test</h1>

        <div class="test-section">
            <h3>1. Connection Test</h3>
            <p>Test if we can connect to the Gradio space.</p>
            <button id="testConnection">Test Connection</button>
            <div id="connectionResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. Sample Image Test</h3>
            <p>Test the API with a sample image URL.</p>
            <button id="testSampleImage">Test with Sample Image</button>
            <div id="sampleResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. File Upload Test</h3>
            <p>Upload your own image to test the API.</p>
            <input type="file" id="fileInput" class="file-input" accept="image/*">
            <br>
            <button id="testFileUpload" disabled>Test File Upload</button>
            <div id="fileResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>System Information</h3>
            <div id="systemInfo">
                <div><strong>Browser:</strong> <span id="browserInfo"></span></div>
                <div><strong>User Agent:</strong> <span id="userAgent"></span></div>
                <div><strong>ES6 Modules:</strong> <span id="moduleSupport"></span></div>
                <div><strong>Time:</strong> <span id="currentTime"></span></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

        class GradioTester {
            constructor() {
                this.spaceUrl = "aliakrem/lung_tumor_prediction";
                this.client = null;
                this.initializeElements();
                this.bindEvents();
                this.updateSystemInfo();
            }

            initializeElements() {
                this.testConnectionBtn = document.getElementById('testConnection');
                this.testSampleBtn = document.getElementById('testSampleImage');
                this.testFileBtn = document.getElementById('testFileUpload');
                this.fileInput = document.getElementById('fileInput');

                this.connectionResult = document.getElementById('connectionResult');
                this.sampleResult = document.getElementById('sampleResult');
                this.fileResult = document.getElementById('fileResult');
            }

            bindEvents() {
                this.testConnectionBtn.addEventListener('click', () => this.testConnection());
                this.testSampleBtn.addEventListener('click', () => this.testSampleImage());
                this.testFileBtn.addEventListener('click', () => this.testFileUpload());

                this.fileInput.addEventListener('change', (e) => {
                    this.testFileBtn.disabled = e.target.files.length === 0;
                });
            }

            updateSystemInfo() {
                document.getElementById('browserInfo').textContent = navigator.userAgent.split(' ').slice(-1)[0];
                document.getElementById('userAgent').textContent = navigator.userAgent;
                document.getElementById('moduleSupport').textContent = 'Yes (ES6 modules working)';
                document.getElementById('currentTime').textContent = new Date().toLocaleString();
            }

            showResult(element, message, type = 'loading') {
                element.style.display = 'block';
                element.className = `result ${type}`;
                element.textContent = message;
            }

            async testConnection() {
                const btn = this.testConnectionBtn;
                const result = this.connectionResult;

                btn.disabled = true;
                this.showResult(result, 'Connecting to Gradio space...', 'loading');

                try {
                    console.log('Starting connection test...');
                    const startTime = Date.now();

                    this.client = await Client.connect(this.spaceUrl);

                    const endTime = Date.now();
                    const duration = endTime - startTime;

                    const successMessage = `âœ… Connection successful!
Space: ${this.spaceUrl}
Connection time: ${duration}ms
Client ready: ${!!this.client}`;

                    this.showResult(result, successMessage, 'success');
                    console.log('Connection test passed:', this.client);

                } catch (error) {
                    const errorMessage = `âŒ Connection failed!
Error: ${error.message}
Space: ${this.spaceUrl}
Please check if the space is running.`;

                    this.showResult(result, errorMessage, 'error');
                    console.error('Connection test failed:', error);
                } finally {
                    btn.disabled = false;
                }
            }

            async testSampleImage() {
                const btn = this.testSampleBtn;
                const result = this.sampleResult;

                if (!this.client) {
                    this.showResult(result, 'âŒ Please test connection first!', 'error');
                    return;
                }

                btn.disabled = true;
                this.showResult(result, 'Fetching sample image and testing API...', 'loading');

                try {
                    console.log('Starting sample image test...');
                    const startTime = Date.now();

                    // Fetch a sample medical image
                    const imageUrl = "https://raw.githubusercontent.com/gradio-app/gradio/main/test/test_files/bus.png";
                    const response = await fetch(imageUrl);
                    const imageBlob = await response.blob();

                    console.log('Sample image loaded, calling API...');

                    const apiResult = await this.client.predict("/predict_tumor_json", {
                        image: imageBlob,
                    });

                    const endTime = Date.now();
                    const duration = endTime - startTime;

                    console.log('API response:', apiResult);

                    if (apiResult && apiResult.data && apiResult.data[0]) {
                        const prediction = apiResult.data[0];
                        const successMessage = `âœ… API call successful!
Duration: ${duration}ms
Predicted class: ${prediction.class || 'N/A'}
Confidence: ${prediction.confidence ? (prediction.confidence * 100).toFixed(2) + '%' : 'N/A'}
Response: ${JSON.stringify(prediction, null, 2)}`;

                        this.showResult(result, successMessage, 'success');
                    } else {
                        throw new Error('Invalid API response format');
                    }

                } catch (error) {
                    const errorMessage = `âŒ API test failed!
Error: ${error.message}
Please check if the prediction endpoint is working.`;

                    this.showResult(result, errorMessage, 'error');
                    console.error('Sample image test failed:', error);
                } finally {
                    btn.disabled = false;
                }
            }

            async testFileUpload() {
                const btn = this.testFileBtn;
                const result = this.fileResult;
                const file = this.fileInput.files[0];

                if (!this.client) {
                    this.showResult(result, 'âŒ Please test connection first!', 'error');
                    return;
                }

                if (!file) {
                    this.showResult(result, 'âŒ Please select a file first!', 'error');
                    return;
                }

                btn.disabled = true;
                this.showResult(result, `Uploading ${file.name} and testing API...`, 'loading');

                try {
                    console.log('Starting file upload test...');
                    const startTime = Date.now();

                    // Convert file to blob
                    const fileBlob = await this.fileToBlob(file);

                    console.log('File converted, calling API...');

                    const apiResult = await this.client.predict("/predict_tumor_json", {
                        image: fileBlob,
                    });

                    const endTime = Date.now();
                    const duration = endTime - startTime;

                    console.log('API response:', apiResult);

                    if (apiResult && apiResult.data && apiResult.data[0]) {
                        const prediction = apiResult.data[0];
                        const successMessage = `âœ… File upload and prediction successful!
File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
Duration: ${duration}ms
Predicted class: ${prediction.class || 'N/A'}
Confidence: ${prediction.confidence ? (prediction.confidence * 100).toFixed(2) + '%' : 'N/A'}
Response: ${JSON.stringify(prediction, null, 2)}`;

                        this.showResult(result, successMessage, 'success');
                    } else {
                        throw new Error('Invalid API response format');
                    }

                } catch (error) {
                    const errorMessage = `âŒ File upload test failed!
File: ${file.name}
Error: ${error.message}`;

                    this.showResult(result, errorMessage, 'error');
                    console.error('File upload test failed:', error);
                } finally {
                    btn.disabled = false;
                }
            }

            async fileToBlob(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const arrayBuffer = reader.result;
                        const blob = new Blob([arrayBuffer], { type: file.type });
                        resolve(blob);
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
        }

        // Initialize tester when page loads
        const tester = new GradioTester();

        // Make it available globally for debugging
        window.gradioTester = tester;

        console.log('Gradio API Tester loaded successfully');
    </script>

    <script>
        // Fallback for browsers without module support
        if (!window.navigator.userAgent.includes('Chrome') ||
            !window.navigator.userAgent.includes('Firefox') ||
            !window.navigator.userAgent.includes('Safari')) {
            console.warn('This test requires a modern browser with ES6 module support');
        }
    </script>
</body>
</html>
